	<section class="create">	
		<form class="ch-form " name="createForm" id="createForm" action="/congrats.html">	
			<input type="hidden" id="initPoint" name="initPoint" value="">
			<div class="ch-g2-3">
				<fieldset data-step="reason">
					
					<legend>Para qué juntamos plata</legend>

					<div class="ch-form-row ch-form-required">
						<label>Motivo: <em>*</em></label>
						<textarea id="description" class="extra-large" name="description"></textarea>
					</div>

					<div class="ch-form-row ch-form-required">
						<label>Hay que juntar: <em>*</em></label>
						$ <input type="text" pattern="[0-9]*" id="amount" name="amount" class="small" value="0">
					</div>

					
				</fieldset>

				<fieldset data-step="who">
					
					<legend>Quiénes ponen plata</legend>

					<div class="ch-form-row me-included">
						<input type="checkbox" id="meIncluded">
						<label for="meIncluded">Yo incluído</label> <i id="meIncludedHelp" class="ch-icon-question-sign"></i>
					</div>
					<div class="ch-form-row ch-form-required">
						<label>Email: <em>*</em></label>
						<input type="email" id="payer" name="payer" class="extra-large">
					</div>
					<div id="moreEmail"></div>	
					<span class="add-email"><a href="javascript:void(0);" id="addEmail"><i class="ch-icon-plus-sign"></i> Agregar otro</a></span>
				</fieldset>
			</div>
			<aside data-step="summary" class="ch-g1-3">

				<h2>Revisa y confirma</h2>

				<dl class="summary">
					
					<dt>Hay que juntar: </dt>
					<dd id="originalAmount" name="originalAmount"></dd>

					<dt>Costo del servicio: <i id="servicesCostsHelp" class="ch-icon-question-sign"></i></dt>
					<dd id="serviceAmount" name="serviceAmount"></dd>
					
					<dt>Monto Total a Pagar: </dt>
					<dd id="finalAmount" name="finalAmount"></dd>
					
					<dt>Ponen plata:</dt>
					<dd id="quantityForAmount" name="quantityForAmount">1</dd>

					<dt>Cuanto pone cada uno: </dt>
					<dd id="partialAmount" name="partialAmount"></dd>

				</dl>
		
			</aside>
			<span class="ch-loading-big ch-hide"></span>
			<div class="ch-form-actions">
				<button class="ch-btn ch-btn-big" id="next">Confirmar la vaquita</button>
				<p class="disclaimer">Necesitamos tu permiso para juntar la plata y depositarla en tu cuenta de MercadoPago, por eso al confirmar, te pediremos que conectes tu cuenta.</p>
			</div>

		</form>

		
	</section>

	<script language="JavaScript">
	var token;
	var url;
	var result;
	var jsonToPost;
	var json;
	var countEmails = 1;
	var requiredMsg = "Este campo es obligatorio.";
	var mailMsg = "Debes ingresar un mail con un formato valido.";
	var priceMsg = "El formato del monto es incorrecto, recuerda utilizar solo . para los decimales.";
  	var payerEmailValidator = [];


		$('#amount').priceFormat({
		    prefix: '',
		    centsSeparator: ',',
		    thousandsSeparator: '.'
		});
		
	  	var descriptionValidator = $("#description").required(requiredMsg);
	  	var amountValidator = $("#amount").required(requiredMsg).and().price(priceMsg);
	  	payerEmailValidator[0] = $("#payer").required(requiredMsg).and().email(mailMsg);
	  	calculate();

		$("#meIncluded").bind("change" , function(){
			if($("#meIncluded").is(':checked'))
			    countEmails++;
			else
			    countEmails--;
		  	calculate();
	  	});
		  	
	  	$("#amount").bind("change" , function(){
		  	calculate();
	  	});
	
	  	$("[id*=payer]").bind("change" , function(){
		  	calculate();
	  	});
			
		$('form').submit(function(e) {
			$('.ch-loading-big').show();
			e = e || window.event;
			e.preventDefault();
			var myForm = $('form').form();
			myForm.validate();
			if(myForm.isValidated()){
	  	    	MELI.init({client_id: 8258968359213576});
				MELI.login(function() {
					token = MELI.getToken();
				  	$.when(createPreference(), getUser()).then(function(){ $("form").submit(); }, function(){alert("Error");});
				});
			}else{
				$('.ch-loading-big').hide();
			}
			return false;
		});
	
		$('.ch-loading-big').hide()
	    	.ajaxStart(function() {
	        	$(this).show();
	    	})
	    	.ajaxStop(function() {
	        	$(this).hide();
	    	});
	
		$("#addEmail").live('click', function(){
			$("#moreEmail").append("<div class='ch-form-row' id='row" + countEmails + "'><label>Email:</label><input type='email' id='payer" + countEmails + "' name='payer' class='extra-large'> <i id='remove1" + countEmails + "' class='ch-icon-remove-sign remove'></i></div>");
		  	payerEmailValidator[countEmails] = $("#payer" + countEmails).required(requiredMsg).and().email(mailMsg);
			countEmails++;
			calculate();
		});
	
	  	$(".remove").live("click", function(){
	      $(this).parent('div:first').fadeOut('slow', function(){
	        $(this).remove();
			countEmails--;
		  	payerEmailValidator[countEmails] = payerEmailValidator[countEmails].disable();
			calculate();
	       });
	 	});
	
	  	$("textarea").countdown({
			"max": 70,
			"plural": "Quedan # caracteres.",
			"singular": "Queda # caracter."
		});
	
		var meIncludedHelp = $("#meIncludedHelp").tooltip("Vamos a descontar también tu parte.");
		var servicesCostsHelp = $("#servicesCostsHelp").tooltip("%5.99 de Comisión MercadoPago<br>%2.01 de Comisión HagamosUnaVaquita");
		//var connectMPHelp = $("#connectMPHelp").tooltip("HagamosUnaVaquita necesita tu permiso para juntar la plata y depositarla en tu cuenta MercadoPago.");
	
		meIncludedHelp.position({
			"points": "lm rm",
			"offset": "10 0"
		});
	//	connectMPHelp.position({
	//		"points": "lm rm",
	//		"offset": "10 0"
	//	});
		servicesCostsHelp.position({
			"points": "cb ct",
			"offset": "0 -10"
		});

	
	
	function calculate(){
		var amount = unmaskPrice($("#amount"));
		$("#originalAmount").html("$" +(amount * 1.00).toFixed(2));
		$("#serviceAmount").html("$" +(amount *  0.08).toFixed(2));
		$("#finalAmount").html("$" +(amount  *  1.08).toFixed(2));
		$("#partialAmount").html("$" +((amount  *  1.08)/countEmails ).toFixed(2));
		$("#quantityForAmount").html(countEmails);
	};

	function createPreference(){
		var amount = unmaskPrice($("#amount").val());
		jsonToPost =  "{'items': [{'id': '" +
			new Date().getTime() + "','title': '" + $("#description").val() + "', 'quantity': 1, 'unit_price': " + $("#partialAmount").html().replace("$","") + ", 'currency_id': 'ARS', 'picture_url': 'http://hagamosunavaquita.com.ar/cowww.png'} ], 'marketplace_fee' : " + ((amount * 0.016117021277)/countEmails).toFixed(2) +"  }";
	    var url = "https://api.mercadolibre.com/checkout/preferences?access_token=" + token;
		return $.ajax(url, {
		    data : jsonToPost,
		    contentType : 'application/json',
		    type : 'POST',
		    success: function(data) {
			    result = data;
			    MELI.logout();
			    $("#initPoint").val(result.init_point);
			    var input = $("<input>").attr("type", "hidden").attr("name", "partialAmount").val($("#partialAmount").html().replace("$",""));
			    $('form').append(input);	
			    input = $("<input>").attr("type", "hidden").attr("name", "finalAmount").val($("#finalAmount").html().replace("$",""));
			    $('form').append(input);
			    input = $("<input>").attr("type", "hidden").attr("name", "originalAmount").val($("#originalAmount").html().replace("$",""));
			    $('form').append(input);
			    input = $("<input>").attr("type", "hidden").attr("name", "quantityForAmount").val($("#quantityForAmount").html());
			    $('form').append(input);
			    input = $("<input>").attr("type", "hidden").attr("name", "prefId").val(""+result.id+"");
			    $('form').append(input);      
		 }});
	};

	function unmaskPrice(amount){
		return parseFloat(amount.unmask()/100).toFixed(2);
	}

	function getUser(){
		return $.ajax("https://api.mercadolibre.com/users/me?access_token=" + token, {
		    type : 'GET',
		    success: function(data) {
			    var input = $("<input>").attr("type", "hidden").attr("name", "receiverName").val(data.first_name + " " + data.last_name);
			    $('form').append(input);	
			    input = $("<input>").attr("type", "hidden").attr("name", "receiverMail").val(data.email);
			    $('form').append(input);   
		      }});
	};
	  	
	  	

	  	// Show who fieldset as steps
	  	/*$("#reason").bind("click", function(){
	  		event.preventDefault();
	  		$("fieldset[data-step='reason']").addClass("ch-hide");
	  		$("fieldset[data-step='who']").removeClass("ch-hide");
	  	})
	  	 
	  	// Show summary fieldset as steps
	  	$("#who").bind("click", function(){
	  		event.preventDefault();
	  		$("fieldset[data-step='who']").addClass("ch-hide");
	  		$("fieldset[data-step='summary']").removeClass("ch-hide");
	  	})*/
	  	 

	</script>
